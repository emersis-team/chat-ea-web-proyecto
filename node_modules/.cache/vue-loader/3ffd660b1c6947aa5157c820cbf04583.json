{"remainingRequest":"D:\\Trabajos\\CIDESO\\chat-ea-web-proyecto\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\Trabajos\\CIDESO\\chat-ea-web-proyecto\\src\\views\\Chat.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\Trabajos\\CIDESO\\chat-ea-web-proyecto\\src\\views\\Chat.vue","mtime":1597410339101},{"path":"D:\\Trabajos\\CIDESO\\chat-ea-web-proyecto\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\Trabajos\\CIDESO\\chat-ea-web-proyecto\\node_modules\\thread-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\Trabajos\\CIDESO\\chat-ea-web-proyecto\\node_modules\\babel-loader\\lib\\index.js","mtime":499162500000},{"path":"D:\\Trabajos\\CIDESO\\chat-ea-web-proyecto\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\Trabajos\\CIDESO\\chat-ea-web-proyecto\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:Ly8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KCmV4cG9ydCBkZWZhdWx0IHsKICBkYXRhKCkgewogICAgcmV0dXJuIHsKICAgICAgbWVuc2FqZXM6IFtdLAogICAgICB1c2VySWQ6IG51bGwsCiAgICAgIHByaW1lcmFQYWdpbmE6IHRydWUsCiAgICAgIGN1cnJlbnRQYWdlOiAwLAogICAgICBsYXN0UGFnZTogMCwKICAgICAgbWVuc2FqZU9mZnNldDogbnVsbAogICAgfTsKICB9LAogIHByb3BzOiB7fSwKICBjb21wdXRlZDoge30sCiAgbW91bnRlZCgpIHsKICAgIHRoaXMudXNlcklkID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oIiR1c2VySWQiKTsKICAgIHRoaXMuZ2V0Q2hhdCgpOwogICAgdGhpcy5hY3R1YWxpemFyKCk7CiAgICB0aGlzLm1lbnNhamVzID0gW107CiAgICB0aGlzLiRyZWZzLmNoYXRTY3JvbGwuYWRkRXZlbnRMaXN0ZW5lcigidG91Y2htb3ZlIiwgdGhpcy5vblNjcm9sbCk7CiAgfSwKICBjcmVhdGVkKCkgewogICAgdGhpcy4kZXZlbnRIdWIuJG9uKCJjaGF0LWdldCIsIGlkID0+IHRoaXMuZ2V0Q2hhdChpZCkpOwogIH0sCiAgbWV0aG9kczogewogICAgYWN0dWFsaXphcigpIHsKICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIHRoYXQuZ2V0Q2hhdCgpOwogICAgICAgIHRoYXQuYWN0dWFsaXphcigpOwogICAgICB9LCAzMDAwKTsKICAgIH0sCiAgICBnZXRDaGF0KGlkKSB7CiAgICAgIGlmIChpZCA9PSBudWxsKSB7CiAgICAgICAgaWQgPSB0aGlzLiRyb3V0ZS5wYXJhbXMuaWQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5tZW5zYWplcyA9IFtdOwogICAgICAgIHRoaXMucHJpbWVyYVBhZ2luYSA9IHRydWU7CiAgICAgIH0KICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICB0aGlzLiRheGlvcwogICAgICAgIC5nZXQodGhpcy4kbG9jYWx1cmwgKyAiL2FwaS92MS9tZXNzYWdlcy8iICsgaWQpCiAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgIGlmICgKICAgICAgICAgICAgdGhhdC5wcmltZXJhUGFnaW5hID09IHRydWUgJiYKICAgICAgICAgICAgIXRoYXQuaXNPdmVyZmxvd24oZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoImNoYXRTY3JvbGwiKSkKICAgICAgICAgICkgewogICAgICAgICAgICB0aGF0LnByaW1lcmFQYWdpbmEgPSBmYWxzZTsKICAgICAgICAgICAgdGhhdC5nZXRDaGF0UGFnZSgyKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzY3JvbGxlYXIgPSBmYWxzZTsKICAgICAgICAgIHRoYXQubGFzdFBhZ2UgPSByZXNwb25zZS5kYXRhLm1lc3NhZ2VzLmxhc3RfcGFnZTsKICAgICAgICAgIHJlc3BvbnNlLmRhdGEubWVzc2FnZXMuZGF0YS5yZXZlcnNlKCk7CiAgICAgICAgICByZXNwb25zZS5kYXRhLm1lc3NhZ2VzLmRhdGEuZm9yRWFjaChtID0+IHsKICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICF0aGF0Lm1lbnNhamVzLnNvbWUobWVuc2FqZSA9PiBtZW5zYWplLmlkID09IG0uaWQpICYmCiAgICAgICAgICAgICAgbS5jb252ZXJzYXRpb25faWQgPT0gdGhhdC4kcm91dGUucGFyYW1zLmlkCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIHRoYXQubWVuc2FqZXMucHVzaChtKTsKICAgICAgICAgICAgICBzY3JvbGxlYXIgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIGlmIChzY3JvbGxlYXIgPT0gdHJ1ZSkgewogICAgICAgICAgICB0aGF0Lm1lbnNhamVPZmZzZXQgPSB0aGF0Lm1lbnNhamVzW3RoYXQubWVuc2FqZXMubGVuZ3RoIC0gMV07CiAgICAgICAgICAgIHRoYXQuc2Nyb2xsVG9Cb3R0b20oKTsKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICAgIC5jYXRjaChmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgaWYgKHJlc3BvbnNlLnJlc3BvbnNlLnN0YXR1cyA9PSA0MDEpIHsKICAgICAgICAgICAgdGhhdC4kcm91dGVyLnB1c2goIi9sb2dpbiIpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSwKICAgIGdldENoYXRQYWdlKHBhZ2luYSkgewogICAgICB0aGlzLm1lbnNhamVPZmZzZXQgPSB0aGlzLm1lbnNhamVzWzBdOwogICAgICB0aGlzLmN1cnJlbnRQYWdlID0gcGFnaW5hOwogICAgICB2YXIgcGFnID0gIiI7CiAgICAgIGlmIChwYWdpbmEgIT0gbnVsbCkgewogICAgICAgIHBhZyA9ICI/cGFnZT0iICsgcGFnaW5hOwogICAgICB9CiAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgdGhpcy4kYXhpb3MKICAgICAgICAuZ2V0KHRoaXMuJGxvY2FsdXJsICsgIi9hcGkvdjEvbWVzc2FnZXMvIiArIHRoaXMuJHJvdXRlLnBhcmFtcy5pZCArIHBhZykKICAgICAgICAudGhlbihmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgcmVzcG9uc2UuZGF0YS5tZXNzYWdlcy5kYXRhLnJldmVyc2UoKTsKICAgICAgICAgIHRoYXQubWVuc2FqZXMgPSByZXNwb25zZS5kYXRhLm1lc3NhZ2VzLmRhdGEuY29uY2F0KHRoYXQubWVuc2FqZXMpOwogICAgICAgICAgdGhhdC5zY3JvbGxUb0JvdHRvbSgpOwogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgICAgICBpZiAocmVzcG9uc2UucmVzcG9uc2Uuc3RhdHVzID09IDQwMSkgewogICAgICAgICAgICB0aGF0LiRyb3V0ZXIucHVzaCgiL2xvZ2luIik7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9LAogICAgb25TY3JvbGwoKSB7CiAgICAgIHZhciB0YXJnZXQgPSB0aGlzLiRyZWZzLmNoYXRTY3JvbGw7CiAgICAgIGlmICh0YXJnZXQuc2Nyb2xsVG9wIDwgdGFyZ2V0LmNsaWVudEhlaWdodCAqIDAuMSkgewogICAgICAgIGlmICh0aGlzLmN1cnJlbnRQYWdlIDwgdGhpcy5sYXN0UGFnZSkgewogICAgICAgICAgdGhpcy5vZmZzZXQgPSB0aGlzLm9mZnNldCArIHRoaXMubGltaXQ7CiAgICAgICAgICB0aGlzLmN1cnJlbnRQYWdlKys7CiAgICAgICAgICB0aGlzLmdldENoYXRQYWdlKHRoaXMuY3VycmVudFBhZ2UpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIHNjcm9sbFRvQm90dG9tKCkgewogICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgIHRoaXMuJG5leHRUaWNrKCgpID0+IHsKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgKICAgICAgICAgICJjaGF0U2Nyb2xsIgogICAgICAgICkuc2Nyb2xsVG9wID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGhhdC5tZW5zYWplT2Zmc2V0LmlkKS5vZmZzZXRUb3A7CiAgICAgIH0pOwogICAgfSwKICAgIGVudmlhcigpIHsKICAgICAgdGhpcy5zY3JvbGxUb0JvdHRvbSgpOwogICAgICB2YXIgdGV4dG8gPSB0aGlzLiRyZWZzLmlucHV0VGV4dG8udmFsdWU7CiAgICAgIGlmICh0ZXh0byAhPSAiIikgewogICAgICAgIHRoaXMuJHJlZnMuaW5wdXRUZXh0by52YWx1ZSA9ICIiOwogICAgICAgIHZhciBkYXRhID0gbmV3IEZvcm1EYXRhKCk7CiAgICAgICAgZGF0YS5hcHBlbmQoIm1lc3NhZ2UiLCB0ZXh0byk7CiAgICAgICAgZGF0YS5hcHBlbmQoInJlY2VpdmVyX2lkIiwgdGhpcy4kcm91dGUucGFyYW1zLnVzZXJfZGVzdF9pZCk7CiAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgIHRoaXMuJGF4aW9zCiAgICAgICAgICAucG9zdCh0aGlzLiRsb2NhbHVybCArICIvYXBpL3YxL21lc3NhZ2VzIiwgZGF0YSkKICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGF0LmdldENoYXQoKTsKICAgICAgICAgIH0pCiAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgICAgaWYgKHJlc3BvbnNlLnJlc3BvbnNlLnN0YXR1cyA9PSA0MDEpIHsKICAgICAgICAgICAgICB0aGF0LiRyb3V0ZXIucHVzaCgiL2xvZ2luIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYWxlcnQoIlNlIHByb2R1am8gdW4gZXJyb3IsIHJlaW50ZW50ZSIpOwogICAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCiAgICBpc092ZXJmbG93bihlbGVtZW50KSB7CiAgICAgIHJldHVybiAoCiAgICAgICAgZWxlbWVudC5zY3JvbGxIZWlnaHQgPiBlbGVtZW50LmNsaWVudEhlaWdodCB8fAogICAgICAgIGVsZW1lbnQuc2Nyb2xsV2lkdGggPiBlbGVtZW50LmNsaWVudFdpZHRoCiAgICAgICk7CiAgICB9CiAgfQp9Owo="},{"version":3,"sources":["Chat.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAmCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"Chat.vue","sourceRoot":"src/views","sourcesContent":["<template>\n  <div class=\"home\">\n    <div class=\"home-body\">\n      <div class=\"home-right\">\n        <div class=\"chat\">\n          <div id=\"chatScroll\" class=\"chat-scroll\" ref=\"chatScroll\" @scroll=\"onScroll\">\n            <div\n              v-for=\"mensaje in mensajes\"\n              :key=\"mensaje.id\"\n              :id=\"mensaje.id\"\n              class=\"chat-container\"\n              v-bind:class=\"{ 'chat-mensaje-propio': mensaje.sender_id == userId }\"\n            >\n              <div class=\"chat-mensaje\">\n                <label>{{ mensaje.message }}</label>\n              </div>\n            </div>\n          </div>\n\n          <div class=\"chat-bottom\">\n            <input\n              type=\"text\"\n              placeholder=\"Escribe un mensaje aquÃ­\"\n              ref=\"inputTexto\"\n              v-on:keyup.enter=\"enviar()\"\n            />\n            <button class=\"chat-enviar\" @click=\"enviar()\">Enviar</button>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n</template>\n\n<script>\nexport default {\n  data() {\n    return {\n      mensajes: [],\n      userId: null,\n      primeraPagina: true,\n      currentPage: 0,\n      lastPage: 0,\n      mensajeOffset: null\n    };\n  },\n  props: {},\n  computed: {},\n  mounted() {\n    this.userId = localStorage.getItem(\"$userId\");\n    this.getChat();\n    this.actualizar();\n    this.mensajes = [];\n    this.$refs.chatScroll.addEventListener(\"touchmove\", this.onScroll);\n  },\n  created() {\n    this.$eventHub.$on(\"chat-get\", id => this.getChat(id));\n  },\n  methods: {\n    actualizar() {\n      var that = this;\n      setTimeout(function() {\n        that.getChat();\n        that.actualizar();\n      }, 3000);\n    },\n    getChat(id) {\n      if (id == null) {\n        id = this.$route.params.id;\n      } else {\n        this.mensajes = [];\n        this.primeraPagina = true;\n      }\n      var that = this;\n      this.$axios\n        .get(this.$localurl + \"/api/v1/messages/\" + id)\n        .then(function(response) {\n          if (\n            that.primeraPagina == true &&\n            !that.isOverflown(document.getElementById(\"chatScroll\"))\n          ) {\n            that.primeraPagina = false;\n            that.getChatPage(2);\n          }\n          var scrollear = false;\n          that.lastPage = response.data.messages.last_page;\n          response.data.messages.data.reverse();\n          response.data.messages.data.forEach(m => {\n            if (\n              !that.mensajes.some(mensaje => mensaje.id == m.id) &&\n              m.conversation_id == that.$route.params.id\n            ) {\n              that.mensajes.push(m);\n              scrollear = true;\n            }\n          });\n          if (scrollear == true) {\n            that.mensajeOffset = that.mensajes[that.mensajes.length - 1];\n            that.scrollToBottom();\n          }\n        })\n        .catch(function(response) {\n          if (response.response.status == 401) {\n            that.$router.push(\"/login\");\n          }\n        });\n    },\n    getChatPage(pagina) {\n      this.mensajeOffset = this.mensajes[0];\n      this.currentPage = pagina;\n      var pag = \"\";\n      if (pagina != null) {\n        pag = \"?page=\" + pagina;\n      }\n      var that = this;\n      this.$axios\n        .get(this.$localurl + \"/api/v1/messages/\" + this.$route.params.id + pag)\n        .then(function(response) {\n          response.data.messages.data.reverse();\n          that.mensajes = response.data.messages.data.concat(that.mensajes);\n          that.scrollToBottom();\n        })\n        .catch(function(response) {\n          if (response.response.status == 401) {\n            that.$router.push(\"/login\");\n          }\n        });\n    },\n    onScroll() {\n      var target = this.$refs.chatScroll;\n      if (target.scrollTop < target.clientHeight * 0.1) {\n        if (this.currentPage < this.lastPage) {\n          this.offset = this.offset + this.limit;\n          this.currentPage++;\n          this.getChatPage(this.currentPage);\n        }\n      }\n    },\n    scrollToBottom() {\n      var that = this;\n      this.$nextTick(() => {\n        document.getElementById(\n          \"chatScroll\"\n        ).scrollTop = document.getElementById(that.mensajeOffset.id).offsetTop;\n      });\n    },\n    enviar() {\n      this.scrollToBottom();\n      var texto = this.$refs.inputTexto.value;\n      if (texto != \"\") {\n        this.$refs.inputTexto.value = \"\";\n        var data = new FormData();\n        data.append(\"message\", texto);\n        data.append(\"receiver_id\", this.$route.params.user_dest_id);\n        var that = this;\n        this.$axios\n          .post(this.$localurl + \"/api/v1/messages\", data)\n          .then(function() {\n            that.getChat();\n          })\n          .catch(function(response) {\n            if (response.response.status == 401) {\n              that.$router.push(\"/login\");\n            }\n            alert(\"Se produjo un error, reintente\");\n          });\n      }\n    },\n    isOverflown(element) {\n      return (\n        element.scrollHeight > element.clientHeight ||\n        element.scrollWidth > element.clientWidth\n      );\n    }\n  }\n};\n</script>\n\n<style scoped src=\"../assets/css/components/chat.css\"></style>\n<style scoped src=\"../assets/css/views/home.css\"></style>\n"]}]}